2011-03-12 Jim Garlick <garlick@llnl.gov>

	* tests/user/tstat.c : Don't print inode difference.

	* tests/user/tread.c : Provide missing open () mode argument.

	* libdiod/diod_conf.[ch], libdiod/diod_sock.[ch], diod/diod.c,
	diodctl/diodctl.c : Drop support for -a option (disable tcp wrappers).
	If wrappers are compiled in, disable checks by configuring wrappers.

2011-03-11 Jim Garlick <garlick@llnl.gov>

	* libnpclient/read.c : Fix bug in np_gets ().

	* diodctl/ops.c : Handle returning server in multiple reads.

	* diodmount/ctl.c : Fix two bugs in diodctl interface logic.

	* tests/*, diod.spec.in : Consolidate tests under one directory
	and arrange to run them during package build.

2011-03-10 Jim Garlick <garlick@llnl.gov>

	* testkern/Makefile.am : Fix t17 to avoid testing sticky bits on 
	directories since underlying fs limits possible values and 
	causes test to fail.  Change to expected pass.

	* testkern/Makefile.am : Change t16 to expected pass after
	fid leakage bug fix in v9fs.

	* diod/diod.c : Implement distributed advisory locking in
	terms of BSD file locks (with caveats!).

	* testkern/Makefile.am, testkern/t18.out, testkern/t19.out,
	testkern/t23.out, testkern/t24.out : These tests now pass with
	non-distributed advisory locking implementation.

2011-03-09 Jim Garlick <garlick@llnl.gov>

	* diod/diod.c : Clean up non-distributed advisory locking
	implementation to look more like qemu's.

	* testkern/*.exp : Update for harness output.

	* testkern/kconjoin.c : New test harness.

	* diodmount/diodmount.c, diodmount/util.[ch] : Add --stdin option,
	remove --exec, --server testing options.

2011-03-08 Jim Garlick <garlick@llnl.gov>

	* libnpclient/mount.c : Fix error handling that was causing
	testuser/t02 failure.

	* libdiod/diod_auth.c : Clean up.

	* testuser/runtest, testkern/runtest : Use munge auth if configured.

2011-03-07 Jim Garlick <garlick@llnl.gov>

	* libnpclient/fsys.c : Rework to make single-threaded synchronous,
	so that we can use this to do auth in user space, then get rid of
	our reader and pass the fd to the kernel.

	* diod/ops.c : Clear O_CREAT bit in lopen handler rather than
	return EINVAL.  The kernel client correctly uses lcreate when
	it needs to create a file but may pass O_CREAT for an existing file
	if the user provided that bit in the open.

	* libnpfs/fcall.c : Alter refcounting on afid so it can be clunked
	after attach and recycled.  Old code was holding a refcount on it
	after clunk, so when client tried to reuse, for example in a walk,
	the server would return EIO because the fid appeared to be in use
	for something else.

	* libdiod/diod_auth.c : Cleanup:
	- auth_clunk (): overwrite memory containing munge cred.
	- diod_auth_client_handshake (): set np_uerror on npc_puts () error.

	* libnpclient/npclient.h : Add np_auth () prototype.

	* libnpclient/mount.c : Move auth callback from np_mount () to
	np_auth ().  Clunk afid after attach.

2011-03-05 Jim Garlick <garlick@llnl.gov>

	* diod/diod.c : Rename --allow-any to --no-wrap.
	Rename --no-munge-auth to --no-auth.

	* diod/ops.c, diodctl/ops.c : Remove auth checks from attach method.
	Add auth method.

	* libdiod/diod_auth.[ch] : Implement munge-based npfs auth module.
	Add diod_auth_client_handshake () to call from client.

	* testuser/*.c : Change mount command to pass client auth function.

	* diodmount/auth.[ch] : Remove.

	* diodmount/ctl.c : Switch to user space based method.

	* libnpfs/* : Simplify attach method function arguments.

	* libnpclient/mount.c : Implement auth protocol.

	* libnpclient/read.c, libnpclient/write.c : Implement more variants
	of io functions for convenience.

	* libdiod/diod_upool.c : Remove server side authenticaion code.

2011-03-03 Jim Garlick <garlick@llnl.gov>

	* libnpfs/np.c : Fix serialization bug in np_create_tlcreate ().
	Add missing client-side serialization functions.

	* diod/ops.c : diod_lopen: EINVAL on mode & O_CREAT.

	* libnpclient/* : Add mkdir, stat, create, readp, writep; fix bugs.

	* testuser/* : Add more user space tests.

2011-03-02 Jim Garlick <garlick@llnl.gov>

	* libnpclient/* : Get working with tests.

	* testuser/t0[1-3] : Three new trivial tests.

	* testuser/tattach.c, testuser/tread.c : New user space client code.

2011-03-01 Jim Garlick <garlick@llnl.gov>

	* libnpclient/* : Port subset of npfs client to .L.

	* testuser/conjoin.c : Add code to support testing with user clients.

2011-02-28 Jim Garlick <garlick@llnl.gov>

	* diodctl/serv.c : Drop -x argument to diod.

	* diod/diod.c, libdiod/diod_sock.[ch] : 
	When diod is called with -F, exit when last conn drops.

	* libnpfs/srv.c, libnpfs/conn.c, libnpfs/npfs.h :
	Add np_srv_wait_zeroconns(), drop np_conn_waitdone().

	* libnpfs/conn.c : Drop connection pointer val in debug output.

	* diod/ops.c, diod/diod.c, libdiod/diod_conf.[ch] : Remove support
	for --exit-on-lastuse since it is no longer needed by test scripts.

	* testkern/runtest : Drop --exit-on-lastuse from test script.

	* libdiod/diod_sock.c, libnpfs/npfs.h, libnpfs/conn.c : Fix
	np_conn_waitdone () so server can terminate when connection drops.

	* testkern/* : Run tests using safer private server scheme.

	* diod/diod.c : Drop --fdno option and make fd=0 the default.
	Also drop --runas-self and make that the default if not run as root.

	* libdiod/diod_conf.c : Make there be no default 'diodlisten' value.

2011-02-25 Jim Garlick <garlick@llnl.gov>

	* diod/diod.c : Add --fdno option.

	* libdiod/diod_sock.[ch] : Add diod_sock_startfd ().

	* libnpfs/conn.c : Add np_conn_waitdone ().

	* diodmount/* : Add --server and --exec options.

2011-02-23 Jim Garlick <garlick@llnl.gov>

	* libdiod/diod_upool.[ch], libdiod/diod_trans.[ch] : Remove jobid.
	Also clean up conditional munge code.

	* diodmount/ctl.c, diodctl/ops.c : Drop server file and simply
	read port from ctl file.  This makes stashing the jobid across
	a write/read easier since we can attach it to the ctl fid.

	* diodmount/auth.[ch], diodmount/ctl.c : Rather than send jobid
	with munge credential, echo it into the ctl file instead of "new".

	* diodmount/* : Split into multiple files.

2011-02-09 Jim Garlick <garlick@llnl.gov>

	* diodmount/diodmount.c : Set access=user when needed rather than
	assuming that is the default.  Always set access=<euid> for diodctl.

	* diodmount/diodmount.c, diodmount/diodmount.8.in : Rename options:
	- -d,--diod-port to -p,--diod-port
	- -x,--debug     to -d,--v9fs-debug.

2011-02-08 Jim Garlick <garlick@llnl.gov>

	* libixp : Drop aborted attempt to integrate into test suite.

	* testkern : Split off tests that involve mounting the file system.
	Don't run tests if 9p.ko is unavailable.  Mount file system using
	diodmount -d PORT option.

	* diodmount/diodmount.c : Have -d take a port argument instead of
	requiring an additional -oport=PORT.

	* diod/ops.c, libnpfs/np.c : Arrange to return P9_LOCK_ERROR to
	lock request instead of ENOSYS to avoid a BUG() in v9fs.

2011-02-08 Jim Garlick <garlick@llnl.gov>

	* diod/ops.c : Fix some freshly introduced bugs:
	- diod_readlink(): add missing string term to symtgt.
	- diod_setattr(): use lchown() not chown()
	- diod_setattr(): add utimensat AT_SYMLINK_NOFOLLOW flag
	- diod_setattr(): return EINVAL on symlink mode/size update.

	* libnpfs/npfs.h, libnpfs/np.c, libnpfs/fcall.c, libnpfs/file.c,
	libnpfs/fmt.c : Change Npfcall to use union structs, not shared
	variables for all ops.

	* libnpfs/np.c : Fix ordering of args in getattr() serialization.

2011-02-07 Jim Garlick <garlick@llnl.gov>

	* diodmount/diodmount.c, libdiod/diod_sock.[ch] : Connect to server
	in user space and pass trans=fd,rfdno=xx,wfdno=xx instead of
	passing in ip and port with default trans=sock.  Also use host:/aname
	format in mount command now that we can put anything there we want,
	so /proc/mounts looks more "normal".

	* libnpfs/npfs.h, libnpfs/np.c : Begin to add back user space client
	functions.

2011-02-05 Jim Garlick <garlick@llnl.gov>

	* libnpfs/fmt.c : Make printing of p9_str types more uniform.

	* libnpfs/srv.c : Return "unknown" in attach response for unknown
	protocol versions instead of error, per fourth edition version(5).

	* libnpfs/fmt.c, libnpfs/np.c : Unconditionally assume .u versions
	of attach and auth.

	* libnpfs/9p.h, libnpfs/np.c : Add P9_NONUNAME constant.

2011-02-04 Jim Garlick <garlick@llnl.gov>

	* man/9p-*.in : Remove man pages in favor of protocol wiki page.

	* libnpfs/fmt.c : Fix some errant debug formatting.

	* libnpfs/np.c : Fix incorrect lcreate response code.
	Handle n_uname, a dotu artifact, in attach if uname is nil.

	* libnpfs/file.c : Fix incorrect lopen respose code.

2011-02-03 Jim Garlick <garlick@llnl.gov>

	* : Remove 9p2000 and 9p2000.u support.  It's 9P2000.L or bust.

2011-02-02 Jim Garlick <garlick@llnl.gov>

	* libixp/* : Import clone from http://hg.suckless.org/libixp
	to use for user space client testing.

	* libnpfs/srv.c, libnpfs/file.c, diod/ops.c, diodmount/diodmount.c :
	Disable server protocol fallback.  Force diodctl legacy, diod .L or
	.u if .L is not configured.

2011-02-01 Jim Garlick <garlick@llnl.gov>

	* diod/ops.c, man/*, libnpfs/* : Code and documentation cleanup.

2011-01-31 Jim Garlick <garlick@llnl.gov>

	* diod/ops.c, libnpfs/fcall.c : Add .L ops:
	readlink, symlink, mknod, setattr, lcreate, link, fsync, mkdir.

2011-01-29 Jim Garlick <garlick@llnl.gov>

	* libnpfs/* : Partially flesh out new .L ops.

2011-01-28 Jim Garlick <garlick@llnl.gov>

	* libnpfs/* : Add skeletal implementations of remaining .L operations.

2011-01-27 Jim Garlick <garlick@llnl.gov>

	* libnpfs/np.c, diod/ops.c : Fix readdir implementation for .L.

2011-01-26 Jim Garlick <garlick@llnl.gov>

	* man/* : Begin documenting 9P2000.L.

	* libnpfs/* : Add lopen, readdir implementation for .L.

2011-01-25 Jim Garlick <garlick@llnl.gov>

	* libnpfs/np.c : Display an error for unhandled ops.

	* libnpfs/fmt.c : Decode all new .L ops, though not yet all args.

	* diodmount/diodmount.c : Add -x option for setting v9fs debug flags.
	If no -x, mount with debug=0 since debug flags are persistent.

	* diod/ops.c, libnpfs/* : Add getattr implementation for .L.

	* diod/ops.c, libnpfs/* : Drop early flock/fcntl locking support.

	* libnpfs/np.c : Remove the R* cases from np_deserialize () and
	the T* create functions for server-side support only.

2011-01-24 Jim Garlick <garlick@llnl.gov>

	* libnpfs/npfile.h : Split out from npfs.h.

	* : Bulk substition of new 9p.h names for constants, etc.

	* libnpfs/9p.h, libnpfs/npfs.h : Import 9p.h from v9fs and remove
	duplicate definitions from npfs.h.

	* diod/diod.c : Add --runas-user option.

	* diod/diod.c, diod/diod.8.in, diodctl/diodctl.c, diodctl/diodctl.8.in :
	Allow -m option to be supplied weven without --enable-munge.

	* libdiod/diod_conf.h : Include proto for get/set_munge unconditionally.

2010-12-17 Jim Garlick <garlick@llnl.gov>

	* : Add --enable-dotl, --enable-munge, and --enable-largeio.

2010-12-13 Jim Garlick <garlick@llnl.gov>

	* libnpfs : Renamed from npfs/libnpfs.  Integrated with automake.
	Removed unused parts of npfs.

	* libdiod : Renamed from common.

2010-09-01 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre10

	* npfs/libnpfs/fcall.c : Revert gcc-4.4 warning fixes.

2010-06-04 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre9

	* npfs/libnpfs/fcall.c : Fix some gcc-4.4 warnings.

2010-06-03 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre8

	* test/t26* : Add test to verify that chgrp works.

	* diod/ops.c : Fix bug in wstat that broke chgrp.

	* test/t25*, test/tfsgid.c : Add test to verify that files are created
	with the appropriate gid.

2010-06-02 Jim Garlick <garlick@llnl.gov>

	* common/diod_conf.c, man/* : Rename diod.conf to diodctl.conf.

2010-06-02 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre7

	* test/t09-mount-9P2000, test/tstatfs.c : Fix spontaneous test failure
	per issue #3.

	* diodmount/diodmount.c, man/diodmount.8.in : Remove -U option.

2010-05-27 Jim Garlick <garlick@llnl.gov>

	* test/t23-fcntl-oneproc : Add test I forgot to check in.

2010-04-29 Jim Garlick <garlick@llnl.gov>

	* test/* : Rework fcntl/flock advisory locking tests.

2010-04-20 Jim Garlick <garlick@llnl.gov>

	* test/t19*, test/tfcntl2.c : Clean up fcntl locking test.

2010-04-19 Jim Garlick <garlick@llnl.gov>

	* common/diod_log.c : Fix bug parsing syslog facility:level.

2010-04-19 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre6

2010-04-15 Jim Garlick <garlick@llnl.gov>

	* tests/* : Add -s option to diod command lines.

	* diod/diod.c : Add a simple stats implementation that tracks 
	read/write iops and byte counts, and fid longevity.

2010-04-13 Jim Garlick <garlick@llnl.gov>

	* diod/diod.c, common/diod_conf.[ch] : Add -s statsfile option.

	* dopd/ops.c : Log EIO on read or write.

	* diod/ops.c, test/t20*, test/t21* : Add debug output for
	DEBUG_ATOMIC in diod_awrite and diod_aread implementation,
	then test for it in tests.  Add test for appending to a file.
	Change cache offsets from u32 to u64.

	* diod/ops.c, test/tfcntl2.c, test/t19* : Add debug output for
	DEBUG_ADVLOCK in diod_lock implementation, then test for it in tests.
	Include aborted attempt to implement diod_lock "natively".

	* diod/ops.c, test/tflock.c, test/t18* : Add debug output for
	DEBUG_ADVLOCK in diod_flock, then test for it in tests.

2010-04-12 Jim Garlick <garlick@llnl.gov>

	* diod/ops.c : Silence some log messages of dubious value that
	caused tests to fail.

	* diodctl/serv.c : Start new diod servers with the same logging
	option as diodctl.

	* diodctl/diodctl.c, diod/diod.c : Add -L (log-dest) option.
	Don't presume syslog if stderr is not a tty.

	* common/diod_log.[ch] : Add capability to redirect logging to a file,
	or to different syslog facilities and levels.

2010-04-09 Jim Garlick <garlick@llnl.gov>

	* common/diod_sock.c : Fix a msg () format error.

	* common/diod_log.h : Identify printf-like functions to gcc.

	* diodctl/serv.c, diod/diod.c, common/diod_sock.c : Fix bug where
	diodctl's listen socket remained open in its children, preventing
	it from being independently restarted.

	* scripts/diodctl.init.in : In service_restart, call service_stop
	and service_start directly instead of $0 stop && $0 start.
	For some reason $0 start did not work in this context.

	* diodctl/serv.c : Use jobid in addition to uid to identify servers.
	Set name of child diod to descriptive name like "diod-shared",
	"diod-jobid-%s", or "diod-uid-%d".

	* diodctl/ops.c : Pass jobid, stored in transport, into
	diodctl_serv_create() and diodctl_serv_getname().

	* common/diod_trans.c : Store jobid with munge info in transport.
	Access with diod_trans_set_authuser() and diod_trans_get_jobid().

2010-04-08 Jim Garlick <garlick@llnl.gov>

	* common/diod_upool.c : If munge cred includes a payload, store it
	with the Npuser struct, and allow it to be retrieved with
	diod_user_get_authinfo.

	* diodmount/diodmount.c : Add -j (jobid) option, and embed string
	in munge payload.

	* test/t20-aread, test/t21-awrite : Tests for atomic I/O.

	* diod/diod.c, diod/ops.c, common/diod_conf.[ch], diodctl/serv.c :
	Added -A (atomic-max) option to limit max size of atomic transfers.

2010-04-06 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre5

	* diodmount/diodmount.c : Update mtab in single non-direct mount case.

	* diodctl/serv.c : Reap children even if they start DOA.

	* common/diod_sock.c : Fix logic error in diod_sock_tryconnect
	that caused all the retries to be used every time.

	* diodctl/serv.c, common/diod_conf.c : Generate one exports file
	in run dir and share it instead of generating one in /tmp per server.

	* test/*, diodctl/serv.c : Don't start diod with -f.

	* man/diod.conf.5.in, man/diod.8.in : Update to reflect drop of -f.

	* diod/diod.c : Drop -f option.  Don't damonize or raise resource
	limits.  Instead depend on inheritance from diodctl.

	* diodctl/diodctl.c : Create run dir if it doesn't exist.

	* scripts/diodctl.init.in, configure.ac, diod.spec : Rename init
	script from diod to diodctl.

	* diodmount/diodmount.c : Add documentation.  Fix diodmount -a to
	prepend directory to mount paths in /etc/mtab.
	
2010-04-05 Jim Garlick <garlick@llnl.gov>

	* diodctl/serv.c : Set diod argv[0] to diod-private or diod-shared
	rather than diod-<uid>.

	* diodmount/diodmount.c : Mount diodctl in a child process that
	has unshared its file system namespace.  Don't special-case a mount
	of /diodctl.  Change options:
	- Add -a (--mount-all).
	- Add -U (--unmount-all).
	- Add -f (--fake-mount).
	- Add -D (--create-directories).
	- Drop -x (--list-exports).

	* test/tstat.c : fsid is an expected failure.  Don't print details
	of the discrepency because if the value changes the test will fail.

	* man/diodmount.8.in : Update to reflect current options.

2010-04-02 Jim Garlick <garlick@llnl.gov>

	* common/diod_conf.c :
	- Avoid calling stat on mount points in diod_conf_validate_exports ().
	- Rename 'diodctllisten' to listen', drop 'diodlisten'.
	- Drop 'runasuid' config file key word.
	- Drop 'allowprivate' config file key word.

	* diodmount/diodmount.c : Option changes:
	- Drop -p (private) option.
	- Add -d (direct) option.

	* diodctl/srv.c : Pass all info to diod on the command line.

	* diodctl/diodctl.c : Option changes:
	- Allow multiple -e (export) options.
	- Allow multiple -l (listen) options.

	* diod/diod.c : Option changes:
	- Drop -c option, and do not read config file.
	- Allow multiple -e (export) options.
	- Allow multiple -l (listen) options.
	- Add -E option to read exports from a flat file (made by diodctl).

2010-04-01 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre4

	* diod/ops.c, tests/t19* : Initial fcntl lock implementation.

	* diod/ops.c, tests/t18* : Initial flock implementation.

	* : Remove vestiges of 9P20000.H.  It's all .L now.

2010-03-24 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre3

	* diodmount/diodmount.c : Add --verbose option.
	Mount diod with 'datacheck' option by default.

2010-03-23 Jim Garlick <garlick@llnl.gov>

	* test/t16-stat, test/tstat.c : Compare stat results.

	* test/t17-chmod : Make sure all mode bits can be set and read
	on client and server.

	* diodmount/opt.c : Match mount options caselessly.

	* diod/diod.c, diod/ops.c, common/diod_conf.[ch] : Drop readahead
	option.

2010-03-22 Jim Garlick <garlick@llnl.gov>

	* diod/ops.c : _ustat2qid: assign inode number directly to qid->path.

2010-03-19 Jim Garlick <garlick@llnl.gov>

	* diod/ops.c, man/9p-*.in : Document 9P2000.L ops vs 9P2000.H.

	* npfs/include/npfs.h, npfs/libnpfs/conn.c, npfs/libnpfs/srv.c,
	npfs/libnpfs/file.c, npfs/libnpfs/fcall.c : Convert proto_version
	from a bitmask to discrete value like in upstream v9fs.

2010-03-17 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre2

	* diod/diod.c, diodctl/diodctl.c : Daemonize before listening or
	daemon () closes our ports for us.  Remove log complaints about chdir
	to rundir.

	* diodctl/ops.c : Include a log message for all attach failures.

	* test/Makefile.am : Remove test directories only if they exist.

	* common/diod_sock.[ch], diodctl/serv.c : Fix a bug in the testing
	of the connection to private diod server.  Also restructure the code
	to test all of the listen addresses until successful.  Improve
	logging on failure.

2010-03-16 Jim Garlick <garlick@llnl.gov>

	* : tag 1.0-pre1
